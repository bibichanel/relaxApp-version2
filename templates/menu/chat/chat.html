<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Chat</title>

    {% load static %}
    <link rel="stylesheet" href="{% static 'css/menu/chat/chat.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css">
</head>
<body>
    <div class='container'>
        <div class='container-logo'>
            <img src="{% static 'image/logoChat.png' %}" alt="Logo"> 
        </div>
        <div class='container-music'>
            <div class='quick-player'>
                <i class="fas fa-volume-up"></i>
                <i class="fas fa-step-backward"></i>
                <i class="fas fa-play"></i>
                <i class="fas fa-pause"></i>
                <i class="fas fa-step-forward"></i>
            </div>
            <div class='music-content'>
                <h2>You are listening to the song: Đừng ai nhắc về cô ấy - Phạm anh quân</h2>
            </div>
        </div>
        <!-- ------------------------------------------------------------ -->
        <div class='container-main'>
             <!-- ------------------------------tools------------------------------ -->
            <div class='container-tools'>
                 <!-- ---------------------------btn choose name--------------------------------- -->
                <div class='tool-choose-name'>
                    <form action=".">
                        <div class="choose">
                            <input type="radio"  name="choose01" value="Nickname">
                            <label for="choose01">Use your nickname</label><br>
                        </div>
                        <div class='choose'>
                            <input type="radio"  name="choose01" value="NewName">
                            <label for="choose01">Use a different name</label><br>
                        </div>
                        <div class='type-sub'>
                            <input id='text-type' type="text" for='choose01' placeholder="Type new name">
                            <input id='sub-type' type="submit" value="Use">
                        </div>
                      </form>
                </div>
                 <!-- -------------------------------frame user--------------------------- -->
                <div class='frame-user'>
                    <table>
                        <tbody>
                            <tr class='row-user'>
                                <td class="td-dote"><i class="fas fa-circle"></i></td>
                                <td class='td-icon-user'><i class="fas fa-user-tie"></i></td>
                                <td class='td-name'><p>nickname</p></td>
                            </tr>
                            <tr class='row-user'>
                                <td class="td-dote"><i class="fas fa-circle"></i></td>
                                <td class='td-icon-user'><i class="fas fa-user-tie"></i></td>
                                <td class='td-name'><p>bibichanel</p></td>
                            </tr>
                            <tr class='row-user'>
                                <td class="td-dote"><i class="fas fa-circle"></i></td>
                                <td class='td-icon-user'><i class="fas fa-user-tie"></i></td>
                                <td class='td-name'><p>nickname123</p></td>
                            </tr>
                            <tr class='row-user'>
                                <td class="td-dote"><i class="fas fa-circle"></i></td>
                                <td class='td-icon-user'><i class="fas fa-user-tie"></i></td>
                                <td class='td-name'><p>Alice</p></td>
                            </tr>
                            <tr class='row-user'>
                                <td class="td-dote"><i class="fas fa-circle"></i></td>
                                <td class='td-icon-user'><i class="fas fa-user-tie"></i></td>
                                <td class='td-name'><p>Bob</p></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                 <!-- ---------------------------------choose background--------------------------- -->
                <div class= 'choose-background'>
                    <div class='content-cb'>
                        <h3>Choose Background</h3>
                    </div>
                    <div class='drop-btn'>
                        <input type="text" placeholder="Background hill digital">
                    </div>
                </div>
            </div>
             <!-- --------------------------------frame chat---------------------------- -->
            <div class='container-chat'>
                <div class='header-chat'>
                    <div class='logo-chat'>  
                        <i class="far fa-comments"></i>
                    </div>
                    <div class='name-room'>
                        <h2>Anonymous chat room</h2>
                    </div>
                </div>
                <!-- ------------------------- -->
                <div class="chat-box"  id='chat-messages'>
                    {% for item in messages %}
                    {% if item.username.username == user.username %}
                    <div class="massage-outgoing">
                        <div class="container-name-detail">
                            <div class="name-user"><p>{{ item.usernameAnonymous }}</p></div>
                            <div class="detail-outgoing"><p>{{ item.content }}</p></div>
                        </div>
                        <div class="icon-user-name">
                            <i class="far fa-user"></i>
                        </div>
                    </div>
                    {% else %}
                    <div class="message-incoming">
                        <div class="icon-user-name">
                            <i class="far fa-user"></i>
                        </div>
                        <div class="container-name-detail">
                            <div class="name-user"><p>{{ item.usernameAnonymous }}</p></div>
                            <div class="detail-incoming"><p>{{ item.content }}</p></div>
                        </div>
                    </div>
                    {% endif%}
                    {% endfor %}

                </div>
                <!-- ------------------------- -->
                <div class="container-typing-area">
                    <form action="." class='typing-area'>
                        <input type="text" name="" id="chat-massager-input" placeholder="Typing a message here ...">
                        <a class ='btn-messager-submit' id='chat-massager-submit'><i class="fab fa-telegram-plane"></i></a>
                    </form>
                </div>
            </div>
        </div>
        <!-- ------------------------------------------------------------ -->
        <div class='container-footer'>
            <h3>relax.it@gmail.com</h3>
        </div>
    </div>
    <section>
        {{ room_name|json_script:"json-roomname" }}
        {{ user.nickname|json_script:"json-nickname" }}
        {{ user.username|json_script:"json-username" }}
    </section>
    <script>
        function scrollToBottom(){
            let objDiv = document.getElementById("chat-messages");
            objDiv.scrollTop = objDiv.scrollHeight;
        };
        scrollToBottom();

        const _roomName = JSON.parse(document.getElementById('json-roomname').textContent);
        const _username = JSON.parse(document.getElementById('json-username').textContent);
        const _nickname = JSON.parse(document.getElementById('json-nickname').textContent);


        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/'
            + _roomName
            + '/'
        );
        chatSocket.onmessage = function(e){
            console.log('onmessage');

            const data = JSON.parse(e.data);

            let string_of_html_messager = null;
            if(data.message){
                if(data.nickname == _nickname){
                    string_of_html_messager = 
                    `
                    <div class="massage-outgoing">
                        <div class="container-name-detail">
                            <div class="name-user"><p>`+data.nickname+`</p></div>
                            <div class="detail-outgoing" ><p>`+data.message+`</p></div>
                        </div>
                        <div class="icon-user-name">
                            <i class="far fa-user"></i>
                        </div>
                    </div>
                    `;
                } else{
                    string_of_html_messager =
                    `
                    <div class="message-incoming">
                        <div class="icon-user-name">
                            <i class="far fa-user"></i>
                        </div>
                        <div class="container-name-detail">
                            <div class="name-user"><p>`+data.nickname+`</p></div>
                            <div class="detail-incoming"><p>`+data.message+`</p></div>
                        </div>
                    </div>
                    `;
                }
                
                document.querySelector('#chat-messages').innerHTML += string_of_html_messager;
            }
            else{
                alert('The message is empty!');
            }
            scrollToBottom();
        };
        chatSocket.onclose = function(e) {
            console.log('The socket close');
        }
        document.querySelector('#chat-massager-input').onkeyup = function(e) {
            if (e.keyCode === 13) {
                    document.querySelector('#chat-massager-submit').click();
                }
        };
        document.querySelector('#chat-massager-submit').onclick = function(e){
            const messageInputDom = document.querySelector('#chat-massager-input');
            const message = messageInputDom.value;

            chatSocket.send(JSON.stringify({
                'message': message,
                'username': _username,
                'room': _roomName,
                'nickname' : _nickname
            }));

            messageInputDom.value = ''
        };
    </script>
</body>
</html>